<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="UTF-8" />
  <title>TT 4.1</title>
  <style>
    #button-row {
      display: flex;
      gap: 15px;          /* mezery mezi tlačítky */
      margin-bottom: 20px;
    }
    #button-row button {
      flex: 1;            /* tlačítka se rozdělí rovnoměrně */
      padding: 15px 25px; /* větší velikost */
      font-size: 1.2em;
      cursor: pointer;
      border-radius: 8px;
      border: 2px solid #007BFF;
      background-color: #E7F1FF;
      transition: background-color 0.3s;
    }
    #button-row button:hover {
      background-color: #B0D2FF;
    }
  </style>
</head>
<body>
  <h1>TT</h1>
  <div id="button-row">
    <button id="upload-ended-btn">Nahrej do ended</button>
    <button id="upload-upcoming-btn">Nahraj do upcoming</button>
    <button id="update-odds-btn">Dopln kurz</button>
    <button id="filter-btn">Zobrazit budoucí zápasy</button>
    <button id="forehand-filter-btn">FILTR 3:0</button>
    <button id="sety-filter-btn">SETY</button>
  </div>
  <div id="output-ended"></div>
  <div id="output-upcoming"></div>
  <div id="output-odds"></div>
  <div id="statusMessages" style="margin-bottom: 10px; color: green;"></div>
  <div id="filtered-table"></div>
  <div id="max-time-display"></div>
<script>
/* =========================
   MAX ENDED TIME
   ========================= */
async function loadMaxEndedTime() {
  const output = document.getElementById('max-time-display');
  output.textContent = 'Načítám...';

  try {
    const res = await fetch('/api/max-ended-time');
    const data = await res.json();

    if (!data.maxTimeISO) {
      output.textContent = 'Žádná data nebyla nalezena.';
      return;
    }

    const maxTime = new Date(data.maxTimeISO);
    const diffHours = Math.round(((Date.now() - maxTime) / 36e5) * 10) / 10;
    const dateStr = maxTime.toLocaleString('cs-CZ');

    output.textContent =
      `Maximální čas ze tabulky ended: ${dateStr} (před ${diffHours} h)`;
  } catch (e) {
    output.textContent = `Chyba: ${e.message}`;
  }
}
window.addEventListener('DOMContentLoaded', loadMaxEndedTime);

/* =========================
   NAHRÁT ENDED
   ========================= */
document.getElementById('upload-ended-btn').addEventListener('click', async () => {
  const out = document.getElementById('output-ended');
  out.textContent = 'Nahrávám ended...';

  try {
    const r = await fetch('/matches');
    const d = await r.json();
    out.textContent = `Hotovo. Ukončené zápasy: ${d.total}`;
  } catch (e) {
    out.textContent = `Chyba: ${e.message}`;
  }
});

/* =========================
   NAHRÁT UPCOMING
   ========================= */
document.getElementById('upload-upcoming-btn').addEventListener('click', async () => {
  const out = document.getElementById('output-upcoming');
  const msg = document.getElementById('statusMessages');

  out.textContent = 'Nahrávám upcoming...';
  msg.innerHTML = '';

  try {
    const r = await fetch('/upcoming');
    const d = await r.json();

    if (d.messages?.length) {
      msg.innerHTML = d.messages.map(m => `<p>${m}</p>`).join('');
    }

    out.textContent = `Hotovo. Nadcházející zápasy: ${d.total}`;
  } catch (e) {
    out.textContent = `Chyba: ${e.message}`;
  }
});

/* =========================
   UPDATE KURZŮ
   ========================= */
document.getElementById('update-odds-btn').addEventListener('click', async () => {
  const out = document.getElementById('output-odds');
  out.textContent = 'Aktualizuji kurzy...';

  try {
    const r = await fetch('/update-odds');
    const d = await r.json();
    out.textContent = `Kurzy aktualizovány (${d.updatedCount ?? 'ok'})`;
  } catch (e) {
    out.textContent = `Chyba: ${e.message}`;
  }
});

/* =========================
   POMOCNÉ FUNKCE
   ========================= */
const formatDate = d => {
  const x = new Date(d);
  return `${x.getDate().toString().padStart(2, '0')}.` +
         `${(x.getMonth() + 1).toString().padStart(2, '0')} ` +
         `${x.getHours().toString().padStart(2, '0')}:` +
         `${x.getMinutes().toString().padStart(2, '0')}`;
};

/* =========================
   FILTR 3:0
   ========================= */
document.getElementById('forehand-filter-btn').addEventListener('click', async () => {
  const container = document.getElementById('filtered-table');
  const messageContainer = document.getElementById('statusMessages');
  container.innerHTML = 'Načítám data...';
  messageContainer.innerHTML = '';
  try {
    const response = await fetch('/api/filter-3-0');
    if (!response.ok) throw new Error('Chyba serveru při načítání dat');
    const data = await response.json();

    if (!Array.isArray(data.matches)) {
      container.innerHTML = 'Neočekávaná odpověď ze serveru.';
      console.error('Neočekávaná data:', data);
      return;
    }

    if (data.messages && data.messages.length > 0) {
      messageContainer.innerHTML = data.messages.map(m => `<p>${m}</p>`).join('');
    }
     // filtr
        const filter3 = data.matches.filter(m => {
          const recentEnough = new Date(m.cas) > new Date(Date.now() - 15 * 60 * 1000);
          const basicThreshold = m.h2h_100 > 8 && m.h2h_300 > 16;
          const cond2 = (m.home_100 < 2 && m.home_100> 0 && m.home_300< 4) || (m.away_100 > 0 && m.away_100< 2 && m.away_300< 4);
          const cond25 = (m.home_100 < 2.6 && m.home_100> 0 && m.kurz> 1.17 && m.home_300< 4) || (m.away_100 > 0 && m.away_100< 2.6  && m.kurz> 1.17 && m.away_300< 4);
          const cond3 = (m.home_100 < 3.2 && m.home_100> 0 && m.kurz> 1.37 && m.home_300< 4.3) || (m.away_100 > 0 && m.away_100< 3.2  && m.kurz> 1.37 && m.away_300< 4.3);
          const cond4 = (m.home_100 < 4 && m.home_100> 0 && m.kurz> 1.58 && m.home_300< 4.6) || (m.away_100 > 0 && m.away_100< 4  && m.kurz> 1.58 && m.away_300< 4.6);
          const liga = (m.league_name==='TT Elite Series' &&  ((m.home_100< 3 &&  m.home_300< 3.5 &&  m.home_300>1) || (m.away_100< 3 &&  m.away_300< 3.5 && m.away_300>1))) || m.league_name==='Setka Cup'
          
          return recentEnough && basicThreshold && (cond2 || cond25 || cond3 || cond4) && liga;
        });
   let html = '<table border="1" cellpadding="5"><thead><tr>';
    const headers = [
      'Datum a čas', 'Liga', 'Domácí', 'Hosté',
      'H2H 30', 'H2H 100', 'H2H 300', '','H 30', 'Home 100', 'H 300', '', 'A 30', 'Away 100', 'A 300', '', 'Kurz', 'Min Kurz'
    ];
    headers.forEach(h => {
      if (h === '') {
       html += `<th style="width: 4px; padding: 0; border-left:4px solid blue;"></th>`;
      } else {
        html += `<th>${h}</th>`;
      }
    });
    html += '</tr></thead><tbody>';

    filter3.forEach(row => {
  function colorize(value) {
    if (value === null || value === undefined) return 'transparent';
    if (value < 2) return '#90ee90';
    if (value >= 2 && value < 3) return '#b4eeb4';
    if (value >= 3 && value < 4) return '#d6f5d6';
    if (value > 6) return '#d3d3d3';
    return 'transparent';
  }
  function formatDateDDMMHHMM(date) {
  const d = new Date(date);
  const day = d.getDate().toString().padStart(2, '0');
  const month = (d.getMonth() + 1).toString().padStart(2, '0');
  const hours = d.getHours().toString().padStart(2, '0');
  const minutes = d.getMinutes().toString().padStart(2, '0');
  return `${day}.${month} ${hours}:${minutes}`;
}

  const isH2h30Low = row.h2h_30 < 5;

  html += `<tr>
    <td>${row.cas ? formatDateDDMMHHMM(row.cas) : ''}</td>
    <td>${row.league_name || ''}</td>
    <td>${row.home_name || ''}</td>
    <td>${row.away_name || ''}</td>
     <td style="background-color: ${isH2h30Low ? '#FFFFE0' : 'transparent'}">${isH2h30Low ? '---' : (row.h2h_30 || '')}</td>
    <td style="background-color: ${row.h2h_100 < 15 ? '#FFC0CB' : 'transparent'}">${row.h2h_100 || ''}</td>
    <td style="background-color: ${row.h2h_300 < 21 ? '#FFC0CB' : 'transparent'}">${row.h2h_300 || ''}</td>
    <td style="width: 4px; padding: 0; border-left: 4px solid blue;"></td>
   <td style="background-color: ${isH2h30Low ? '#FFFFE0' : colorize(row.home_30)}">${isH2h30Low ? '---' : (row.home_30 || '')}</td>
    <td style="background-color: ${colorize(row.home_100)}">
  ${row.home_100 !== null && row.home_100 !== undefined ? row.home_100 + ' (' + (row.home_100 * 1.2).toFixed(2) + ')' : ''}
  </td>
    <td style="background-color: ${colorize(row.home_300)}">${row.home_300 || ''}</td>
    <td style="width: 4px; padding: 0; border-left: 4px solid blue;"></td>
    <td style="background-color: ${isH2h30Low ? '#FFFFE0' : colorize(row.away_30)}">${isH2h30Low ? '---' : (row.away_30 || '')}</td>
    <td style="background-color: ${colorize(row.away_100)}">
  ${row.away_100 !== null && row.away_100 !== undefined ? row.away_100 + ' (' + (row.away_100 * 1.2).toFixed(2) + ')' : ''}
</td>
    <td style="background-color: ${colorize(row.away_300)}">${row.away_300 || ''}</td>
    <td style="width: 4px; padding: 0; border-left: 4px solid blue;"></td>
    <td>${row.kurz || ''}</td>
    <td style="background-color: ${
  row.kurz_min_30 > row.kurz ? '#FFC0CB' :         // větší než kurz => růžová
  row.kurz_min_30 * 1.1 > row.kurz ? '#FFFFE0' :  // větší než kurz*1,1 => světle žlutá
  row.kurz_min_30 < row.kurz / 1.25 ? '#ADD8E6' :   // menší než kurz/1,3 => světle modrá
  'transparent'                                    // jinak bez barvy
}">${row.kurz_min_30 || ''}</td>
  </tr>`;
});


    html += '</tbody></table>';
    container.innerHTML = html;
  } catch (error) {
    container.innerHTML = `Chyba: ${error.message}`;
  }
});

/* =========================
   SETY – FILTR
   ========================= */
document.getElementById('sety-filter-btn').addEventListener('click', async () => {
  const c = document.getElementById('filtered-table');
  const msg = document.getElementById('statusMessages');

  c.innerHTML = 'Načítám SETY...';
  msg.innerHTML = '';

  try {
    const r = await fetch('/api/filter-sety');
    const d = await r.json();

    const filtered = d.matches.filter(m =>
      new Date(m.cas) > new Date(Date.now() - 15 * 60 * 1000) &&
      m.h2h_100 > 5 && m.sety_300 > 50 &&
      (
       (m.u17_100 > 12 && m.u17_300 > 12) || (m.u17_100 < 2.9 && m.u17_300 < 2.9) ||
       (m.u18_100 > 6 && m.u18_300 > 6) || (m.u18_100 < 2.05 && m.u18_300 < 2.05) ||
        (m.u19_100 > 2.7 && m.u19_300 > 2.7) || (m.u19_100 < 1.5 && m.u19_300 < 1.5) ||
        (m.u20_100 > 1.8 && m.u20_300 > 1.8) || (m.u20_100 < 1.15 && m.u20_300 < 1.15) 
        )
        );

    let html = `
      <table border="1" cellpadding="5">
        <thead>
          <tr>
            <th>Datum</th><th>Liga</th><th>Domácí</th><th>Hosté</th>
            <th>H2H</th><th></th>
            <th>Sety100</th><th>U16_5</th><th>U17_5</th><th>U18_5</th><th>U19_5</th>
            <th></th>
            <th>Sety300</th><th>U16_5</th><th>U17_5</th><th>U18_5</th><th>U19_5</th>
            <th></th><th>Kurz</th>
          </tr>
        </thead><tbody>`;

    filtered.forEach(r => {
      html += `
        <tr>
          <td>${formatDate(r.cas)}</td>
          <td>${r.league_name}</td>
          <td>${r.home_name}</td>
          <td>${r.away_name}</td>
          <td>${r.h2h_100}</td>
          <td style="border-left:4px solid blue"></td>
<td style="background-color: ${r.sety_100 < 15 ? '#FFC0CB' : 'transparent'}">${r.sety_100 || ''}</td>        
<td style="background-color: ${r.u17_100 < 2.9 ? '#90EE90' : r.u17_100 > 12 ? '#FFC0CB' : 'transparent'}">
  ${r.u17_100 ?? ''}
  ${r.u17_100 > 1 ? ` (${(r.u17_100 / (r.u17_100 - 1)).toFixed(2)})` : ''}
</td>
<td style="background-color: ${r.u18_100 < 2.05 ? '#90EE90' : r.u18_100 > 6 ? '#FFC0CB' : 'transparent'}">
  ${r.u18_100 ?? ''}
  ${r.u18_100 > 1 ? ` (${(r.u18_100 / (r.u18_100 - 1)).toFixed(2)})` : ''}
</td>
<td style="background-color: ${r.u19_100 < 1.5 ? '#90EE90' : r.u19_100 > 2.7 ? '#FFC0CB' : 'transparent'}">
  ${r.u19_100 ?? ''}
  ${r.u19_100 > 1 ? ` (${(r.u19_100 / (r.u19_100 - 1)).toFixed(2)})` : ''}
</td>
<td style="background-color: ${r.u20_100 < 1.15 ? '#90EE90' : r.u20_100 > 1.8 ? '#FFC0CB' : 'transparent'}">
  ${r.u20_100 ?? ''}
  ${r.u20_100 > 1 ? ` (${(r.u20_100 / (r.u20_100 - 1)).toFixed(2)})` : ''}
</td>
<td style="border-left:4px solid blue"></td>
<td style="background-color: ${r.sety_300 < 15 ? '#FFC0CB' : 'transparent'}">${r.sety_300 || ''}</td>
<td style="background-color: ${r.u17_300 < 2.9 ? '#90EE90' : r.u17_300 > 12 ? '#FFC0CB' : 'transparent'}">
  ${r.u17_300 ?? ''}
  ${r.u17_300 > 1 ? ` (${(r.u17_300 / (r.u17_300 - 1)).toFixed(2)})` : ''}
</td>

<td style="background-color: ${r.u18_300 < 2.05 ? '#90EE90' : r.u18_300 > 6 ? '#FFC0CB' : 'transparent'}">
  ${r.u18_300 ?? ''}
  ${r.u18_300 > 1 ? ` (${(r.u18_300 / (r.u18_300 - 1)).toFixed(2)})` : ''}
</td>

<td style="background-color: ${r.u19_300 < 1.5 ? '#90EE90' : r.u19_300 > 2.7 ? '#FFC0CB' : 'transparent'}">
  ${r.u19_300 ?? ''}
  ${r.u19_300 > 1 ? ` (${(r.u19_300 / (r.u19_300 - 1)).toFixed(2)})` : ''}
</td>

<td style="background-color: ${r.u20_300 < 1.15 ? '#90EE90' : r.u20_300 > 1.8 ? '#FFC0CB' : 'transparent'}">
  ${r.u20_300 ?? ''}
  ${r.u20_300 > 1 ? ` (${(r.u20_300 / (r.u20_300 - 1)).toFixed(2)})` : ''}
</td>

          <td style="border-left:4px solid blue"></td>
          <td>${r.kurz}</td>
        </tr>`;
    });

    html += '</tbody></table>';
    c.innerHTML = html;

  } catch (e) {
    c.innerHTML = `Chyba: ${e.message}`;
  }
});
/* =========================
   4,5 – FILTR
   ========================= */
    document.getElementById('filter-btn').addEventListener('click', async () => {
      const container = document.getElementById('filtered-table');
      container.innerHTML = 'Načítám...';
      try {
        const response = await fetch('/api/filter-upcoming');
        if (!response.ok) throw new Error('Chyba serveru při načítání zápasů');
        const allMatches = await response.json();
        if (!Array.isArray(allMatches)) {
          container.innerHTML = 'Neočekávaná odpověď ze serveru.';
          console.error('Neočekávaná data:', allMatches);
          return;
        }
        // stávající filtr, který už máte
        const filtered = allMatches.filter(m => {
          const recentEnough = new Date(m.cas) > new Date(Date.now() - 15 * 60 * 1000);
          const basicThreshold = m.h2h_100 > 8 && m.h2h_300 > 16 && m["35_100"] > 0;
          const cond45a = (m["45_100"] < 1.29 || m["45_300"] < 1.29) && m["45_100"] < 1.4 && m["45_300"] < 1.4;
          const cond35a = (m["35_100"] < 2.1 || m["35_300"] < 2.1) && m["35_100"] < 3 && m["35_300"] < 3;
          const negatedCond = !((m["45_100"] > 1.245 && m["45_300"] > 1.295) || (m["45_100"] > 1.29 && m["45_300"] > 1.245)) || m["35_100"] < 2.1 || m["35_300"] < 2.1;
          return recentEnough && basicThreshold && (cond45a || cond35a) && negatedCond;
        });
        let html = '<table border="1" cellpadding="5"><thead><tr>';
const headers = ['Datum a čas', 'Domácí', 'Hosté', 'H2H 100', '35_100', '45_100', 'H2H 300', '35_300', '45_100', 'Kurz', 'Chyb'];

headers.forEach(h => {
  if (h === '') {
    html += `<th style="border-left: 4px solid blue;"></th>`; // Oddělovač ve hlavičce
  } else {
    html += `<th>${h}</th>`;
  }
});
html += '</tr></thead><tbody>';

        filtered.forEach(row => {
          html += `<tr>
            <td>${row.cas ? new Date(row.cas).toLocaleString() : ''}</td>
            <td>${row.home_name || ''}</td>
            <td>${row.away_name || ''}</td>
            <td style="background-color: ${row.h2h_100 < 15 ? '#FFC0CB' : 'transparent'}">${row.h2h_100 || ''}</td>
            <td style="background-color: ${row["35_100"] < 2 ? '#ADD8E6' : 'transparent'}">${row["35_100"] || ''}</td>
            <td style="background-color: ${row["45_100"] < 1.25 ? '#90EE90' : 'transparent'}">${row["45_100"] || ''}</td>
            <td style="background-color: ${row.h2h_300 < 20 ? '#FFC0CB' : 'transparent'}">${row.h2h_300 || ''}</td>
            <td style="background-color: ${row["35_300"] < 2 ? '#ADD8E6' : 'transparent'}">${row["35_300"] || ''}</td>
            <td style="background-color: ${row["45_300"] < 1.25 ? '#90EE90' : 'transparent'}">${row["45_300"] || ''}</td>
            <td style="background-color: ${row.kurz < 1.31 ? '#FFC0CB' : row.kurz > 1.55 ? '#D1F9B3' : 'transparent'}">${row.kurz || ''}</td>
            <td>${row.chyba_poctu || ''}</td>
          </tr>`;
        });
        html += '</tbody></table>';
        container.innerHTML = html;
      } catch (error) {
        container.innerHTML = `Chyba: ${error.message}`;
      }
    });
  
</script>

  
</body>
</html>
