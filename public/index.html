<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="UTF-8" />
  <title>TT 3.0</title>
  <style>
    #button-row {
      display: flex;
      gap: 15px;          /* mezery mezi tlačítky */
      margin-bottom: 20px;
    }
    #button-row button {
      flex: 1;            /* tlačítka se rozdělí rovnoměrně */
      padding: 15px 25px; /* větší velikost */
      font-size: 1.2em;
      cursor: pointer;
      border-radius: 8px;
      border: 2px solid #007BFF;
      background-color: #E7F1FF;
      transition: background-color 0.3s;
    }
    #button-row button:hover {
      background-color: #B0D2FF;
    }
  </style>
</head>
<body>
  <h1>TT 3:0</h1>
  <div id="button-row">
    <button id="upload-ended-btn">Nahrej do ended</button>
    <button id="upload-upcoming-btn">Nahraj do upcoming</button>
    <button id="update-odds-btn">Dopln kurz</button>
    <button id="filter-btn">Zobrazit budoucí zápasy</button>
    <button id="forehand-filter-btn">FILTR 3:0</button>
    <button id="sety-filter-btn">SETY</button>
  </div>
  <div id="output-ended"></div>
  <div id="output-upcoming"></div>
  <div id="output-odds"></div>
  <div id="statusMessages" style="margin-bottom: 10px; color: green;"></div>
  <div id="filtered-table"></div>
  <div id="max-time-display"></div>
<script>
/* =========================
   MAX ENDED TIME
   ========================= */
async function loadMaxEndedTime() {
  const output = document.getElementById('max-time-display');
  output.textContent = 'Načítám...';

  try {
    const res = await fetch('/api/max-ended-time');
    const data = await res.json();

    if (!data.maxTimeISO) {
      output.textContent = 'Žádná data nebyla nalezena.';
      return;
    }

    const maxTime = new Date(data.maxTimeISO);
    const diffHours = Math.round(((Date.now() - maxTime) / 36e5) * 10) / 10;
    const dateStr = maxTime.toLocaleString('cs-CZ');

    output.textContent =
      `Maximální čas ze tabulky ended: ${dateStr} (před ${diffHours} h)`;
  } catch (e) {
    output.textContent = `Chyba: ${e.message}`;
  }
}
window.addEventListener('DOMContentLoaded', loadMaxEndedTime);

/* =========================
   NAHRÁT ENDED
   ========================= */
document.getElementById('upload-ended-btn').addEventListener('click', async () => {
  const out = document.getElementById('output-ended');
  out.textContent = 'Nahrávám ended...';

  try {
    const r = await fetch('/matches');
    const d = await r.json();
    out.textContent = `Hotovo. Ukončené zápasy: ${d.total}`;
  } catch (e) {
    out.textContent = `Chyba: ${e.message}`;
  }
});

/* =========================
   NAHRÁT UPCOMING
   ========================= */
document.getElementById('upload-upcoming-btn').addEventListener('click', async () => {
  const out = document.getElementById('output-upcoming');
  const msg = document.getElementById('statusMessages');

  out.textContent = 'Nahrávám upcoming...';
  msg.innerHTML = '';

  try {
    const r = await fetch('/upcoming');
    const d = await r.json();

    if (d.messages?.length) {
      msg.innerHTML = d.messages.map(m => `<p>${m}</p>`).join('');
    }

    out.textContent = `Hotovo. Nadcházející zápasy: ${d.total}`;
  } catch (e) {
    out.textContent = `Chyba: ${e.message}`;
  }
});

/* =========================
   UPDATE KURZŮ
   ========================= */
document.getElementById('update-odds-btn').addEventListener('click', async () => {
  const out = document.getElementById('output-odds');
  out.textContent = 'Aktualizuji kurzy...';

  try {
    const r = await fetch('/update-odds');
    const d = await r.json();
    out.textContent = `Kurzy aktualizovány (${d.updatedCount ?? 'ok'})`;
  } catch (e) {
    out.textContent = `Chyba: ${e.message}`;
  }
});

/* =========================
   POMOCNÉ FUNKCE
   ========================= */
const formatDate = d => {
  const x = new Date(d);
  return `${x.getDate().toString().padStart(2, '0')}.` +
         `${(x.getMonth() + 1).toString().padStart(2, '0')} ` +
         `${x.getHours().toString().padStart(2, '0')}:` +
         `${x.getMinutes().toString().padStart(2, '0')}`;
};

const colorize = v => {
  if (v === null || v === undefined) return 'transparent';
  if (v < 1.5) return '#90EE90';
  if (v > 10) return '#D3D3D3';
  return 'transparent';
};

/* =========================
   FILTR 3:0
   ========================= */
document.getElementById('forehand-filter-btn').addEventListener('click', async () => {
  const c = document.getElementById('filtered-table');
  const msg = document.getElementById('statusMessages');
  c.innerHTML = 'Načítám 3:0...';
  msg.innerHTML = '';

  const r = await fetch('/api/filter-3-0');
  const d = await r.json();

  const filtered = d.matches.filter(m =>
    new Date(m.cas) > new Date(Date.now() - 15 * 60 * 1000) &&
    m.h2h_100 > 8 &&
    (
      (m.home_100 > 0 && m.home_100 < 4) ||
      (m.away_100 > 0 && m.away_100 < 4)
    )
  );

  let html = '<table border="1"><tbody>';
  filtered.forEach(r => {
    html += `
      <tr>
        <td>${formatDate(r.cas)}</td>
        <td>${r.home_name}</td>
        <td>${r.away_name}</td>
        <td>${r.kurz}</td>
      </tr>`;
  });
  html += '</tbody></table>';

  c.innerHTML = html;
});

/* =========================
   SETY – HLAVNÍ FILTR
   ========================= */
document.getElementById('sety-filter-btn').addEventListener('click', async () => {
  const c = document.getElementById('filtered-table');
  const msg = document.getElementById('statusMessages');

  c.innerHTML = 'Načítám SETY...';
  msg.innerHTML = '';

  try {
    const r = await fetch('/api/filter-sety');
    const d = await r.json();

    const filtered = d.matches.filter(m =>
      new Date(m.cas) > new Date(Date.now() - 15 * 60 * 1000) &&
      m.h2h_100 > 8 &&
      (
        (m.u17_100 > 0 && m.u17_100 < 10) ||
        (m.u18_100 > 0 && m.u18_100 < 10) ||
        (m.u19_100 > 0 && m.u19_100 < 10) ||
        (m.u20_100 > 0 && m.u20_100 < 10)
      )
    );

    let html = `
      <table border="1" cellpadding="5">
        <thead>
          <tr>
            <th>Datum</th><th>Liga</th><th>Domácí</th><th>Hosté</th>
            <th>H2H</th><th></th>
            <th>Sety100</th><th>U17</th><th>U18</th><th>U19</th><th>U20</th>
            <th></th>
            <th>Sety300</th><th>U17</th><th>U18</th><th>U19</th><th>U20</th>
            <th></th><th>Kurz</th>
          </tr>
        </thead><tbody>`;

    filtered.forEach(r => {
      html += `
        <tr>
          <td>${formatDate(r.cas)}</td>
          <td>${r.league_name}</td>
          <td>${r.home_name}</td>
          <td>${r.away_name}</td>
          <td>${r.h2h_100}</td>
          <td style="border-left:4px solid blue"></td>
          <td style="background:${colorize(r.sety_100)}">${r.sety_100}</td>
          <td style="background:${colorize(r.u17_100)}">${r.u17_100}</td>
          <td style="background:${colorize(r.u18_100)}">${r.u18_100}</td>
          <td style="background:${colorize(r.u19_100)}">${r.u19_100}</td>
          <td style="background:${colorize(r.u20_100)}">${r.u20_100}</td>
          <td style="border-left:4px solid blue"></td>
          <td style="background:${colorize(r.sety_300)}">${r.sety_300}</td>
          <td style="background:${colorize(r.u17_300)}">${r.u17_300}</td>
          <td style="background:${colorize(r.u18_300)}">${r.u18_300}</td>
          <td style="background:${colorize(r.u19_300)}">${r.u19_300}</td>
          <td style="background:${colorize(r.u20_300)}">${r.u20_300}</td>
          <td style="border-left:4px solid blue"></td>
          <td>${r.kurz}</td>
        </tr>`;
    });

    html += '</tbody></table>';
    c.innerHTML = html;

  } catch (e) {
    c.innerHTML = `Chyba: ${e.message}`;
  }
});
</script>

  
</body>
</html>
