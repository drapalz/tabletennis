<!DOCTYPE html>
<html lang="cs">
<head>
  <meta charset="UTF-8" />
  <title>Table Tennis</title>
</head>
<body>
  <h1>TableTennis</h1>
  <button id="run-btn">Spustit vše</button>
  <div id="output"></div>
  <script>
    document.getElementById('run-btn').addEventListener('click', async () => {
      const output = document.getElementById('output');
      output.textContent = 'Probíhá spouštění...';
      try {
        const res = await fetch('/run-all');
        if (!res.ok) throw new Error('Chyba serveru');
        const data = await res.json();
        output.textContent = `Hotovo. Ukončené zápasy: ${data.endedMatchesCount}, Nadcházející zápasy: ${data.upcomingMatchesCount}.`;
      } catch (e) {
        output.textContent = `Chyba: ${e.message}`;
      }
    });
  </script>
  <div id="max-time-display"></div>
  <script>
    // Funkce načte a zobrazí max čas ihned po načtení stránky
    async function loadMaxEndedTime() {
      const output = document.getElementById('max-time-display');
      output.textContent = 'Načítám...';
      try {
        const res = await fetch('/api/max-ended-time');
        if (!res.ok) throw new Error('Chyba serveru');
        const data = await res.json();
        if (data.maxTimeISO) {
         const dateStr = new Date(data.maxTimeISO).toLocaleString('cs-CZ', { timeZone: 'Europe/Prague' });
        output.textContent = `Maximální čas ze tabulky ended je: ${dateStr}`;
        } else {
          output.textContent = 'Žádná data nebyla nalezena.';
        }
      } catch (err) {
        output.textContent = `Chyba: ${err.message}`;
      }
    }

    window.addEventListener('DOMContentLoaded', loadMaxEndedTime);
  </script>
  <button id="filter-btn">Zobrazit budoucí zápasy</button>
  <div id="filtered-table"></div>
  <script>
    async function loadFilteredMatches() {
      const container = document.getElementById('filtered-table');
      container.innerHTML = 'Načítám...';
      try {
        const response = await fetch('/api/filter-upcoming');
        const allMatches = await response.json();
if (!Array.isArray(allMatches)) {
        container.innerHTML = 'Neočekávaná odpověď ze serveru.';
        console.error('Neočekávaná data:', allMatches);
        return;
      }

      // Filtrování podle podmínek ze zadání
      const filtered = allMatches.filter(m => {
  const recentEnough = new Date(m.cas) > new Date(Date.now() - 15 * 60 * 1000);
  const basicThreshold = m.h2h_100 > 8 && m.h2h_300 > 16 && m["35_100"] > 0;

  const cond45a = (m["45_100"] < 1.29 || m["45_300"] < 1.29) && m["45_100"] < 1.49 && m["45_300"] < 1.49;
  const cond35a = (m["35_100"] < 2.1 || m["35_300"] < 2.1) && m["35_100"] < 3 && m["35_300"] < 3;

  const negatedCond = !
    ((m["45_100"] > 1.245 && m["45_300"] > 1.295) ||
    (m["45_100"] > 1.29 && m["45_300"] > 1.245)) ||
    m["35_100"] < 2.1 || m["35_300"] < 2.1
      ;

  
  return recentEnough && basicThreshold && (cond45a || cond35a) && negatedCond;
});


      // Vykreslení tabulky
      let html = '<table border="1" cellpadding="5"><thead><tr>';
      ['Datum a čas', 'Domácí', 'Hosté', 'H2H 100', '35 100', '45 100', 'H2H 300', '35 300', '45 300', 'Kurz', 'Chyby'].forEach(h => {
        html += `<th>${h}</th>`;
      });
      html += '</tr></thead><tbody>';

      filtered.forEach(row => {
        html += `<tr>
          <td>${row.cas ? new Date(row.cas).toLocaleString() : ''}</td>
          <td>${row.home_name || ''}</td>
          <td>${row.away_name || ''}</td>
          <td style="background-color: ${row.h2h_100 < 15 ? '#FFC0CB' : 'transparent'}">${row.h2h_100 || ''}</td>
          <td style="background-color: ${row["35_100"] < 2 ? '#ADD8E6' : 'transparent'}">${row["35_100"] || ''}</td>
          <td style="background-color: ${row["45_100"] < 1.25 ? '#90EE90' : 'transparent'}">${row["45_100"] || ''}</td>
          <td style="background-color: ${row.h2h_300 < 20 ? '#FFC0CB' : 'transparent'}">${row.h2h_300 || ''}</td>
          <td style="background-color: ${row["35_300"] < 2 ? '#ADD8E6' : 'transparent'}">${row["35_300"] || ''}</td>
          <td style="background-color: ${row["45_300"] < 1.25 ? '#90EE90' : 'transparent'}">${row["45_300"] || ''}</td>
          <td style="background-color: ${row.kurz < 1.31 ? '#FFC0CB' : 
                                         row.kurz > 1.55 ? '#D1F9B3' :
                                         'transparent'}">${row.kurz || ''}</td>
          <td>${row.chyba_poctu || ''}</td>
        </tr>`;
      });

      html += '</tbody></table>';
      container.innerHTML = html;

    } catch (error) {
      container.innerHTML = `Chyba: ${error.message}`;
    }
  }

  document.getElementById('filter-btn').addEventListener('click', loadFilteredMatches);
</script>
       
      
</body>
</html>
